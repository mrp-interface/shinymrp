---
title: "Data Preparation for MRP Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data Preparation for MRP Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

## Introduction

Proper data preparation is crucial for successful MRP analysis. This vignette explains the data structure requirements, demonstrates preprocessing workflows using the package's built-in functions, and shows how to work with the example datasets included in shinymrp.

## Data Structure Requirements

### Core Variables

MRP analysis requires specific types of variables to function properly:

**Outcome Variable:**
- **Binary outcomes**: Coded as 0/1 (e.g., voted/didn't vote, positive/negative test)
- **Continuous outcomes**: Numeric values (e.g., income, test scores)

**Geographic Identifiers:**
- **ZIP codes**: 5-digit codes (e.g., "97201", "10001")
- **Counties**: 5-digit FIPS codes (e.g., "41051" for Multnomah County, OR)
- **States**: 2-digit FIPS codes, names, or abbreviations (e.g., "41", "Oregon", "OR")

**Demographic Variables:**
- **Sex**: "male", "female" (case-insensitive)
- **Race**: "white", "black", "hispanic", "asian", "other" (case-insensitive)
- **Age**: Numeric values (will be binned automatically)
- **Education** (optional): "hs", "some college", "4-year college", "post-grad"

**Time Variables** (for time-varying analyses):
- **Dates**: ISO format "YYYY-MM-DD" (e.g., "2020-03-15")
- **Week indices**: Starting from 1 for the earliest week in data

## Example Datasets

The package includes several example datasets demonstrating different MRP scenarios:

### Cross-sectional Binary Data

```{r crosssectional-binary}
library(shinymrp)

# Load cross-sectional binary outcome data
data_path <- system.file("extdata/example/data/crosssectional_binomial_raw.csv", 
                        package = "shinymrp")
cross_data <- read.csv(data_path)

# Examine structure
head(cross_data)
#>      sex  race age   zip county state positive
#> 1   Male White  30 97141  41057    OR        0
#> 2   Male White  32 97212  41051    OR        1
#> 3 Female White  23 97201  41051    OR        1

# Check dimensions and summary
dim(cross_data)
summary(cross_data)
```

### Polling Data with Education

```{r polling-data}
# Load polling data with education and vote share
poll_path <- system.file("extdata/example/data/poll_binomial_raw.csv", 
                         package = "shinymrp")
poll_data <- read.csv(poll_path)

head(poll_data)
#>      sex  race age          edu state positive   repvote
#> 1   male white  38 some college    NY        0 0.3822758
#> 2 female white  65           hs    KY        0 0.6567063
#> 3   male white  61           hs    GA        0 0.5266117

# Note: This dataset includes education and Republican vote share
unique(poll_data$edu)
#> [1] "some college" "hs" "4-year college" "post-grad"
```

### Time-varying Data

```{r timevarying-data}
# Load time-varying data with dates
time_path <- system.file("extdata/example/data/timevarying_binomial_raw.csv", 
                        package = "shinymrp")
time_data <- read.csv(time_path)

head(time_data)
#>      sex  race age time       date   zip county state positive
#> 1   Male Black  50    4 2020-01-20 71354  22025    LA        1
#> 2 Female Black  27    9 2020-02-24 71354  22025    LA        1
#> 3 Female Black  67    3 2020-01-13 71357  22107    LA        1

# Check time range
range(time_data$time)
range(as.Date(time_data$date))
```

### COVID-19 Data

```{r covid-data}
# Load COVID-19 specific data
covid_path <- system.file("extdata/example/data/covid_binomial_raw.csv", 
                         package = "shinymrp")
covid_data <- read.csv(covid_path)

head(covid_data)
#>   masked_id    sex  race age time result_date   zip positive
#> 1  UUVSddmK Female White  79    2  2020-01-06 25033        0
#> 2  5URELPrP Female Other  67    8  2020-02-17 25026        0
#> 3  P2tz5Mal Female Black  38    7  2020-02-10 25036        0

# Note: Includes masked IDs and result dates
```

## Data Preprocessing Workflow

### Automatic Data Cleaning

The package includes robust data cleaning functions that handle common data quality issues:

```{r data-cleaning}
# The clean_data() function (internal) handles:
# - Column name standardization (lowercase, underscores)
# - Duplicate column removal
# - Character trimming and case conversion
# - Missing value standardization
# - Geographic code formatting

# Example of what happens during preprocessing:
raw_data <- data.frame(
  Sex = c("Male", "FEMALE", "male"),
  Race = c("White", "black", "Hispanic"),
  Age = c(25, 45, 67),
  ZIP = c("97201", "10001", "90210"),
  Positive = c("Yes", "No", "1")
)

# After preprocessing (conceptual):
# - Column names: sex, race, age, zip, positive
# - Values: lowercase and trimmed
# - Binary outcomes: converted to 0/1
```

### Geographic Code Validation

```{r geocode-validation}
# ZIP codes are validated and formatted
valid_zips <- c("97201", "10001", "90210")    # Valid 5-digit codes
invalid_zips <- c("9720", "100011", "abc12")  # Invalid formats

# The package automatically:
# - Formats numeric codes with leading zeros
# - Validates 5-digit ZIP format
# - Converts invalid codes to NA
```

### Age Binning

```{r age-binning}
# Ages are automatically binned into standard categories:
age_bins <- c("18-29", "30-44", "45-64", "65+")

# Example ages and their bins:
ages <- c(25, 35, 55, 70)
# Binned as: "18-29", "30-44", "45-64", "65+"
```

### Time Variable Processing

```{r time-processing}
# For time-varying data, dates are converted to week indices
dates <- c("2020-01-06", "2020-01-13", "2020-01-20")

# The get_week_indices() function:
# - Converts dates to ISO week numbers
# - Creates cumulative week indices
# - Handles multi-year date ranges
# - Generates complete timeline
```

## Data Validation

### Required Variable Checks

```{r validation-checks}
# The package validates that required variables are present:
required_vars <- c("sex", "race", "age")  # Minimum demographic variables
geo_vars <- c("zip", "county", "state")  # At least one geographic identifier
outcome_vars <- c("positive", "outcome") # Outcome variable

# Validation includes:
# - Presence of required variables
# - Appropriate data types
# - Valid value ranges
# - Geographic code format
```

### Data Quality Diagnostics

```{r quality-diagnostics}
# The preprocessing workflow provides diagnostics:
# - Missing value patterns
# - Geographic coverage
# - Sample size by subgroups
# - Outcome distribution
# - Time coverage (for time-varying data)
```

## Working with Your Own Data

### File Format Support

```{r file-formats}
# Supported formats:
# - CSV files (.csv)
# - Excel files (.xlsx, .xls)
# - SAS files (.sas7bdat)

# Reading functions automatically detect format:
# read_data("mydata.csv")      # Uses readr::read_csv()
# read_data("mydata.xlsx")     # Uses readxl::read_excel()
# read_data("mydata.sas7bdat") # Uses haven::read_sas()
```

### Column Naming Conventions

```{r naming-conventions}
# Flexible column naming - the package recognizes variations:
# Sex: "sex", "gender", "Sex", "GENDER"
# Race: "race", "ethnicity", "Race", "ETHNICITY"  
# Age: "age", "Age", "AGE"
# ZIP: "zip", "zipcode", "ZIP", "ZIPCODE"
# County: "county", "County", "COUNTY"
# State: "state", "State", "STATE"
# Outcome: "positive", "outcome", "response", "y"
```

### Data Preparation Checklist

Before uploading data to shinymrp:

1. **✓ Outcome Variable**: Binary (0/1) or continuous numeric
2. **✓ Geographic Identifiers**: Valid ZIP codes, county FIPS, or state codes
3. **✓ Demographics**: Sex, race, age (education optional)
4. **✓ Time Variables**: ISO dates (YYYY-MM-DD) if time-varying
5. **✓ Missing Values**: Use standard missing indicators (NA, blank, "")
6. **✓ File Format**: CSV, Excel, or SAS format
7. **✓ Sample Size**: Sufficient observations for stable estimates

## Advanced Preprocessing

### Custom Geographic Linking

```{r custom-geo}
# For custom geographic hierarchies:
# - ZIP to county/state linking available
# - FIPS code conversion utilities
# - Geographic aggregation functions
```

### Poststratification Data

```{r poststrat-data}
# The package includes ACS-based poststratification data:
acs_path <- system.file("extdata/acs/pstrat_poll.csv", package = "shinymrp")
pstrat_data <- read.csv(acs_path)

head(pstrat_data)
# Contains population counts by demographic and geographic strata
```

## Next Steps

- **Model Fitting**: Learn about MRP methodology in `vignette("mrp-methodology")`
- **Interactive Analysis**: Launch the app with `run_app()` to explore your prepared data
- **Live Demo**: Try the interface at [https://mrp-interface.github.io/shinymrp/](https://mrp-interface.github.io/shinymrp/)

## Common Issues and Solutions

**Issue**: Geographic codes not recognized
**Solution**: Ensure ZIP codes are 5 digits, county codes are 5-digit FIPS, state codes are 2-digit FIPS or standard abbreviations

**Issue**: Binary outcomes not detected
**Solution**: Code as 0/1 or use standard text ("yes"/"no", "positive"/"negative")

**Issue**: Time variables not processed
**Solution**: Use ISO date format (YYYY-MM-DD) or sequential week indices starting from 1

**Issue**: Missing demographic categories
**Solution**: Use standard category names (case-insensitive) or "other" for non-standard categories

The robust preprocessing pipeline in shinymrp handles most common data quality issues automatically, making MRP analysis accessible even with imperfect survey data.
---
title: "MRP Methodology Overview"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MRP Methodology Overview}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

## Introduction to MRP

Multilevel Regression and Poststratification (MRP) is a statistical technique that combines multilevel modeling with poststratification to produce more accurate population estimates from survey data. Originally developed for political polling, MRP has become widely used across social sciences, public health, and market research for generalizing findings from non-representative samples to target populations.

## The MRP Framework

MRP addresses two fundamental challenges in survey research:

1. **Non-representative sampling**: Survey respondents often differ systematically from the target population
2. **Small sample sizes**: Limited data for specific demographic or geographic subgroups

The technique works by:
1. **Modeling** the relationship between individual characteristics and outcomes using multilevel regression
2. **Poststratifying** by reweighting predictions according to the true population distribution

## When to Use MRP

MRP is particularly valuable when:

- **Non-probability samples**: Working with convenience samples, online panels, or volunteer surveys
- **Geographic inference**: Estimating outcomes for small areas with limited sample sizes
- **Demographic disparities**: Sample composition differs from population of interest
- **Time-varying estimates**: Tracking changes over time with consistent methodology
- **Policy applications**: Need for reliable estimates to inform decision-making

### Common Applications

**Political Science:**
- Election forecasting from polling data
- Public opinion estimation across constituencies
- Voter turnout prediction

**Public Health:**
- Disease prevalence estimation from convenience samples
- Health behavior surveillance
- COVID-19 tracking and forecasting

**Social Research:**
- Attitude and behavior measurement
- Social media and online survey analysis
- Market research and consumer preferences

## Statistical Foundation

### The Multilevel Model

The first stage of MRP involves fitting a multilevel regression model:

**For binary outcomes (logistic regression):**
$$\text{logit}(p_{i}) = \alpha + \beta X_i + \gamma Z_j + \delta_{j}$$

**For continuous outcomes (linear regression):**
$$y_i = \alpha + \beta X_i + \gamma Z_j + \delta_{j} + \epsilon_i$$

Where:
- $X_i$ represents individual-level predictors (age, sex, race, education)
- $Z_j$ represents group-level predictors (geographic characteristics)
- $\delta_j$ represents group-level random effects (e.g., state or county effects)
- $\epsilon_i$ represents individual-level error (continuous outcomes only)

### Poststratification

The second stage involves poststratification using population data:

$$\hat{\theta} = \sum_{j=1}^{J} \frac{N_j}{N} \hat{\theta}_j$$

Where:
- $\hat{\theta}$ is the population estimate
- $\hat{\theta}_j$ is the predicted outcome for demographic-geographic cell $j$
- $N_j$ is the population size of cell $j$
- $N$ is the total population size

## Implementation in shinymrp

### Model Specification

The package supports flexible model specification through its interface:

**Main Effects:**
- Individual demographics: sex, race, age, education
- Geographic identifiers: state, county, ZIP code
- Time variables: for longitudinal analysis

**Interactions:**
- Demographic interactions (e.g., age × sex)
- Geographic interactions (e.g., state × race)
- Time interactions (e.g., time × demographics)

**Random Effects:**
- Geographic random effects (state, county)
- Time random effects (for time-varying models)
- Cross-classified random effects

### Bayesian Estimation

The package uses Stan for Bayesian estimation, providing:

**Advantages:**
- Full uncertainty quantification
- Robust handling of small sample sizes
- Flexible model specification
- Principled treatment of missing data

**Prior Specifications:**
- Weakly informative priors for regression coefficients
- Hierarchical priors for random effects
- Adaptive priors based on data characteristics

### Model Families

**Binomial Models:**
```{r binomial-model}
# For binary outcomes (0/1)
# Examples: voted/didn't vote, positive/negative test, approve/disapprove
# Link function: logit
# Outcome distribution: Binomial(n, p)
```

**Normal Models:**
```{r normal-model}
# For continuous outcomes
# Examples: income, test scores, ratings
# Link function: identity
# Outcome distribution: Normal(μ, σ)
```

## Model Diagnostics

### Convergence Assessment

The package provides built-in diagnostics:

**R-hat Statistics:**
- Values < 1.1 indicate convergence
- Automatic flagging of problematic parameters

**Effective Sample Size:**
- Measures MCMC efficiency
- Warnings for insufficient sampling

**Trace Plots:**
- Visual assessment of chain mixing
- Detection of convergence issues

### Model Validation

**Posterior Predictive Checks:**
- Compare observed data to model predictions
- Identify systematic model misfit
- Graphical and numerical summaries

**Cross-validation:**
- Leave-one-out cross-validation (LOO-CV)
- Model comparison metrics
- Overfitting detection

## Poststratification Data

### Population Benchmarks

The package includes American Community Survey (ACS) data for poststratification:

**Demographic Strata:**
- Sex: Male, Female
- Race: White, Black, Hispanic, Asian, Other
- Age: 18-29, 30-44, 45-64, 65+
- Education: HS, Some College, 4-year College, Post-grad

**Geographic Levels:**
- State-level estimates
- County-level estimates (where sample sizes permit)

**Time Periods:**
- Multiple ACS vintages available
- Consistent with survey data timing

### Custom Poststratification

For specialized applications:

```{r custom-poststrat}
# Users can provide custom population data
# Must match demographic and geographic strata in survey data
# Format: population counts by strata
```

## Uncertainty Quantification

### Bayesian Credible Intervals

MRP provides full uncertainty quantification:

**Individual Predictions:**
- Point estimates with credible intervals
- Probability statements about outcomes

**Population Estimates:**
- Uncertainty propagated through all modeling stages
- Accounts for sampling variability and model uncertainty

**Geographic Estimates:**
- Uncertainty varies by sample size and model fit
- Smaller areas have wider intervals

### Sources of Uncertainty

1. **Sampling uncertainty**: Limited sample sizes
2. **Model uncertainty**: Parameter estimation uncertainty  
3. **Poststratification uncertainty**: Population benchmark uncertainty
4. **Specification uncertainty**: Model choice and assumptions

## Advantages and Limitations

### Advantages

**Statistical:**
- Principled handling of non-representative samples
- Improved precision through multilevel modeling
- Full uncertainty quantification
- Flexible model specification

**Practical:**
- Works with existing survey data
- Scalable to multiple geographic levels
- Consistent methodology across applications
- Interpretable results

### Limitations

**Data Requirements:**
- Need for demographic and geographic variables
- Population benchmark data required
- Sufficient sample sizes for stable estimates

**Model Assumptions:**
- Assumes model captures key relationships
- Requires appropriate poststratification strata
- Sensitive to model specification

**Computational:**
- Bayesian estimation can be time-intensive
- Requires statistical software and expertise

## Best Practices

### Data Collection

1. **Include key demographics**: Sex, race, age at minimum
2. **Geographic identifiers**: ZIP codes or counties for spatial modeling
3. **Sufficient sample sizes**: Aim for representation across strata
4. **Quality control**: Validate geographic codes and demographic categories

### Model Building

1. **Start simple**: Begin with main effects, add complexity gradually
2. **Check convergence**: Ensure MCMC chains have converged
3. **Validate predictions**: Use posterior predictive checks
4. **Compare models**: Use cross-validation for model selection

### Interpretation

1. **Report uncertainty**: Always include credible intervals
2. **Acknowledge limitations**: Discuss model assumptions and data quality
3. **Validate externally**: Compare to other data sources when possible
4. **Communicate clearly**: Explain methodology to non-technical audiences

## Academic References

Key papers on MRP methodology:

- **Gelman & Little (1997)**: Original MRP paper in political science context
- **Park, Gelman & Bafumi (2004)**: Bayesian multilevel logistic regression for state-level estimates
- **Lax & Phillips (2009)**: Application to state-level policy opinions
- **Buttice & Highton (2013)**: Validation and comparison of MRP approaches
- **Kastellec et al. (2015)**: Polarizing the electoral connection in judicial elections

Recent methodological advances:

- **Gao et al. (2021)**: Deep interactions in MRP
- **Ornstein (2020)**: Stacked regression and poststratification
- **Bradley et al. (2021)**: Bayesian spatial MRP

## Software Implementation

The shinymrp package builds on established R packages:

**Statistical Computing:**
- **Stan/cmdstanr**: Bayesian estimation engine
- **rstanarm**: Pre-compiled Stan models
- **brms**: Flexible Bayesian regression modeling

**Data Processing:**
- **dplyr/tidyr**: Data manipulation
- **readr/readxl/haven**: Data import
- **stringr**: Text processing

**Visualization:**
- **ggplot2**: Statistical graphics
- **highcharter**: Interactive visualizations
- **leaflet**: Interactive maps

## Getting Started with MRP

1. **Explore the interface**: Launch `run_app()` to familiarize yourself with the workflow
2. **Try example data**: Use built-in datasets to understand the methodology
3. **Read the literature**: Consult academic papers for theoretical foundation
4. **Start with simple models**: Build complexity gradually as you gain experience
5. **Validate results**: Compare MRP estimates to external benchmarks when possible

The shinymrp package makes sophisticated MRP analysis accessible while maintaining statistical rigor, enabling researchers to produce reliable population estimates from non-representative survey data.

## Next Steps

- **Getting Started**: Learn basic package usage in `vignette("getting-started")`
- **Data Preparation**: Understand data requirements in `vignette("data-preparation")`
- **Live Demo**: Explore the interface at [https://mrp-interface.github.io/shinymrp/](https://mrp-interface.github.io/shinymrp/)
- **Academic Literature**: Consult the references above for deeper methodological understanding

MRP represents a powerful approach to survey inference that addresses many limitations of traditional weighting approaches, and the shinymrp package makes this methodology accessible to a broader research community.